#!/usr/bin/env bash
# .githooks/pre-commit - Run quality checks before commit
#
# This hook runs:
#   1. Shell script formatting (shfmt)
#   2. Shell script linting (shellcheck)
#   3. Test suite (shellspec)
#
# To skip: git commit --no-verify

set -Eeuo pipefail

echo "ğŸª Running pre-commit checks..."

# Change to project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# 1. Format check
echo "ğŸ“ Checking formatting..."
if command -v shfmt >/dev/null 2>&1; then
  if ! shfmt -d -i 2 -ci -bn bin/* lib/*.sh lib/**/*.sh 2>/dev/null; then
    echo "âŒ Formatting issues found. Run: just fmt"
    exit 1
  fi
  echo "âœ… Formatting OK"
else
  echo "âš ï¸  shfmt not installed, skipping format check"
fi

# 2. Lint check
echo "ğŸ” Running shellcheck..."
if command -v shellcheck >/dev/null 2>&1; then
  if ! just lint >/dev/null 2>&1; then
    echo "âŒ Linting failed. Run: just lint"
    exit 1
  fi
  echo "âœ… Linting OK"
else
  echo "âš ï¸  shellcheck not installed, skipping lint check"
fi

# 3. Test suite (optional, can be slow)
if [ "${SKIP_TESTS:-0}" != "1" ]; then
  echo "ğŸ§ª Running tests..."
  if ! just test >/dev/null 2>&1; then
    echo "âŒ Tests failed. Fix errors or use SKIP_TESTS=1 git commit"
    exit 1
  fi
  echo "âœ… Tests passed"
else
  echo "âš ï¸  Tests skipped (SKIP_TESTS=1)"
fi

echo "âœ… All pre-commit checks passed!"
exit 0
